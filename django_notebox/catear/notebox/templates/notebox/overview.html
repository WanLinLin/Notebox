{% load staticfiles %}
<!doctype html>
<html lang="zh-tw">
<head>
  <meta charset="utf-8">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="{% static 'notebox/css/materialize.min.css' %}" media="screen,projection"/>
  <!-- my style -->
  <link rel="stylesheet" type="text/css" href="{% static 'notebox/css/w-style.css' %}">
  <link rel="stylesheet" type="text/css" href="{% static 'notebox/css/general.css' %}">
  <link rel="stylesheet" href="{% static 'notebox/js/bower_components/tether-drop/dist/css/drop-theme-arrows.min.css' %}" />
  <link rel="stylesheet" href="{% static 'notebox/css/overview.css' %}" />

  <!--let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>歌曲總覽</title>
</head>

<body ng-app="searchApp">
  <!--====================================
  =            Include navbar            =
  =====================================-->
  {% include 'notebox/navbar.html' %}
  <!--====  End of Include navbar  ====-->

  <!--==================================
  =            Main Content            =
  ===================================-->
  <div class="container" ng-controller="searchCtrl">

    <!--==================================
    =            Search panel            =
    ===================================-->

    <div class="row">
      <br><br>
      {% verbatim %}

        <!-- Difficulty -->

        <div class="input-field col s3">
          <select ng-model="search_data.level" ng-change="do_search();">
            <option ng-repeat="option in search_data.level_options"
              value="{{option.value}}">{{option.name}}</option>
          </select>
          <label>困難度</label>
          <!-- <p>{{search_data.level}}</p> -->
        </div>

        <!-- instructment -->

        <div class="input-field col s3">
          <select ng-model="search_data.instructment" ng-change="do_search();">
            <option ng-repeat="option in search_data.instructment_options"
              value="{{option.value}}">{{ option.name }}</option>
          </select>
          <label>樂器種類</label>
          <!-- <p>{{search_data.instructment}}</p> -->
        </div>

        <!-- Keyword search -->

        <div class="input-field col s6">
          <input type="text" id="search-keyword" class="validate"
            ng-model="search_data.keyword" 
            ng-focus="keyword_focused=true" ng-blur="keyword_focused=false"
            ng-keypress="keyword_focused && $event.which == 13 && do_search();"
            placeholder="曲名、作曲家、歌手">
          <label for="search-keyword">關鍵字</label>
          <!-- <p>{{search_data.keyword}}</p> -->
        </div>

        <!-- Chord -->

        <div class="col s10">
          <h6>依照和弦搜尋</h6>
          <div ng-repeat="(option_key, option) in search_data.chord_options" class="chord-btn">
            <label><input type="checkbox" id="{{ option_key }}" ng-model="option.value" ng-model="search_data.keyword" ng-change="do_search();">
              <span>{{ option.name }}</span>
            </label>
          </div>
          <!-- <span ng-repeat="(option_key, option) in search_data.chord_options">
            {{option.name}} = {{option.value}}
          </span> -->
        </div>

        <div class="col s2">
          <h6>排序方式</h6>
          <div class="switch">
            <label>
              最新
              <input type="checkbox" ng-model="search_data.order_by_pupularity" ng-change="do_search()">
              <span class="lever"></span>
              熱門
            </label>
          </div>
        </div>

      {% endverbatim %}
    </div>

    <!--====  End of Search panel  ====-->

    <!--===============================
    =            Music Box            =
    ================================-->

    {% verbatim query_result %}

    <div ng-bind-html="query_result_html"></div>
        
    {% endverbatim query_result %}
    
    <!-- HTML code below is generated by django
    and will be hidden when user start querying -->

    <!--====  End of Music Box  ====-->
    
  </div>
  <!--====  End of Main Content  ====-->

  <!--============================
  =            Footer            =
  =============================-->
  {% include 'notebox/footer.html' %}
  <!--====  End of Footer  ====-->
  

  <!--================================
  =            JavaScript            =
  =================================-->
  <!--import jquery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="{% static 'notebox/js/materialize.min.js' %}"></script>
  <!-- AngularJS -->
  <script type="text/javascript" src="{% static 'notebox/js/bower_components/angular/angular.js' %}"></script>

  <script type="text/javascript">
  $(document).ready(function() {
    $('.button-collapse').sideNav();
    $('.modal-trigger').leanModal();

      // Navbar dropdown setting
      $('.dropdown-button:contains("分類搜尋")').dropdown({
        inDuration: 300,
        constrain_width: false,
        outDuration: 225,
        hover: true, // Activate on hover
        belowOrigin: true,
        alignment: 'left'
      });

      // Init materialized selection

      $('select').material_select();
  });

  // Angular Search

  angular.module("searchApp", [])
    .controller('searchCtrl', ['$scope', '$http', '$sce', function($scope, $http, $sce) {
      $scope.search_data = { // Search data source
        level: '',
        instructment: '',
        chord: '',
        sub_chord: '',
        keyword: '',
        order_by_pupularity: false,

        level_options: [
          {value: '', name: '全部'},
          {value: '1', name: '初級'},
          {value: '2', name: '中級'},
          {value: '3', name: '高級'}
        ],

        instructment_options: [
          {value: '', name: '全部'},
          {value: 'piano', name: '鋼琴'},
          {value: 'guitar', name: '吉他'},
        ],

        chord_options: {
          chord_c:    {value: false, name: "C"},
          chord_cs:   {value: false, name: "C#"},
          chord_db:   {value: false, name: "Db"},
          chord_d:    {value: false, name: "D"},
          chord_ds:   {value: false, name: "D#"},
          chord_eb:   {value: false, name: "Eb"},
          chord_e:    {value: false, name: "E"},
          chord_f:    {value: false, name: "F"},
          chord_fs:   {value: false, name: "F#"},
          chord_gb:   {value: false, name: "Gb"},
          chord_g:    {value: false, name: "G"},
          chord_gs:   {value: false, name: "G#"},
          chord_ab:   {value: false, name: "Ab"},
          chord_a:    {value: false, name: "A"},
          chord_as:   {value: false, name: "A#"},
          chord_bb:   {value: false, name: "Bb"},
          chord_b:    {value: false, name: "B"}
        },
      };

      $scope.query_result_html = '';

      $scope.do_search = function() { // Search function
        // Save keywords

        var level         = $scope.search_data.level;
        var instructment  = $scope.search_data.instructment;
        var keyword       = $scope.search_data.keyword;
        var order_by_pupularity = $scope.search_data.order_by_pupularity;

        // Extract checked chords from the models

        var chord = [];
        var chord_options = $scope.search_data.chord_options;
        for (var key in chord_options) {
          if (chord_options[key].value)
            chord.push(chord_options[key].name)
        }
        chord = chord.join();

        // Test catched values

        // console.log('level: ' + level);
        // console.log('instructment: ' + instructment);
        // console.log(chord);
        // console.log('keyword: ' + keyword);

        // Do querying here 
        
        $http({   // AJAX
          method: 'GET',
          url: '{% url "query_song" %}',
          params: {
            level: level,
            instructment: instructment,
            keyword: keyword,
            chord: chord,
            odp: order_by_pupularity,
          }
        }).then(function successCallback(response) {  // On success
          // Success

          var data = response.data;
          // console.log(data);

          // Update model (now the way we use is inserting the HTML code)

          if (data.num_result === 0) {
            $scope.query_result_html = $sce.trustAsHtml("<h4>無法找到匹配的歌曲</h4>");  
          }
          else {
            $scope.query_result_html = $sce.trustAsHtml(data.html_code);  
          }

        }, function errorCallback(response) { // On error
          // Error
        });
      };

      $scope.do_search(); // Init the first search
  }]);
  </script>
  <!--====  End of JavaScript  ====-->
</body>
</html>
